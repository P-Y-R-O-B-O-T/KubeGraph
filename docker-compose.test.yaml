services:
  cluster-state:
    image: kubegraph-cluster-state:latest
    container_name: cluster-state-kubegraph
    restart: unless-stopped
    volumes:
      - /kubeconf:/kubeconf
    networks:
      - cluster-state-kubegraph
    environment:
      - CLUSTER_STATE_API_CRED_USER=${CLUSTER_STATE_API_CRED_USER}
      - CLUSTER_STATE_API_CRED_PASSWD=${CLUSTER_STATE_API_CRED_PASSWD}

  mongo:
    image: mongo
    container_name: mongo-kubegraph
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - 27072:27017
    networks:
      - mongo-kubegraph

  redis:
    image: redis:8.0.2-alpine3.21
    container_name: redis-kubegraph
    restart: unless-stopped
    networks:
        - redis-kubegraph

  api:
    image: kubegraph-api:latest
    container_name: api-kubegraph
    restart: unless-stopped
    ports:
      - 8888:8000
    networks:
      - api-kubegraph
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - API_AUTH_SECRET_KEY=${API_AUTH_SECRET_KEY}

  init-db:
    image: python:3.12.10-slim-bookworm
    container_name: init-db
    restart: false
    networks:
      - mongo-kubegraph
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - ADMIN_API_CRED_USER=${ADMIN_API_CRED_USER}
      - ADMIN_API_CRED_PASSWD=${ADMIN_API_CRED_PASSWD}
      - CLUSTER_WATCH_API_CRED_USER=${CLUSTER_WATCH_API_CRED_USER}
      - CLUSTER_WATCH_API_CRED_PASSWD=${CLUSTER_WATCH_API_CRED_PASSWD}
      - CLUSTER_STATE_API_CRED_USER=${CLUSTER_STATE_API_CRED_USER}
      - CLUSTER_STATE_API_CRED_PASSWD=${CLUSTER_STATE_API_CRED_PASSWD}

networks:
  cluster-state-kubegraph:
  mongo-kubegraph:
  redis-kubegraph:
  api-kubegraph:

volumes:
  kubeconfig:
    driver: local
